# abort script on any command that exits with a non zero value
set -e

if [ -f /etc/redhat-release ]; then
  # install libjson0 for CentOS stemcells
  yum install -y json-c
elif [ -f /etc/lsb-release ]; then
  # install libjson0 for Ubuntu stemcells (not tested)
  apt-get install libjson0
fi

# BOSH_INSTALL_TARGET=/mnt/tmp
# Install GNU C Library (glibc) statically-linked
git clone git://sourceware.org/git/glibc.git
pushd glibc
  # CentOS 7 uses glibc version 2.17
  # but we use version 2.18 because 2.17 is very
  # difficult to compile statically, e.g.
  # need to make dynamic first to avoid
  # ../include/stdc-predef.h:64:1: fatal error: /mnt/tmp/glibc/build/libc-modules.h: No such file or directory
  # --enable-static-nss see:
  # https://sourceware.org/glibc/wiki/FAQ#Even_statically_linked_programs_need_some_shared_libraries_which_is_not_acceptable_for_me.__What_can_I_do.3F
  # --disable-nscd to avoid nsswitch.c:101:15: error: ‘nscd_init_cb’ defined but not used [-Werror=unused-variable]
  # static void (*nscd_init_cb) (size_t, struct traced_file *);
  git checkout -b local_glibc-2.18
  mkdir build
  pushd build
    ../configure \
      --prefix=/usr
    time make
    ../configure \
      --prefix=/usr \
      --enable-static
    time make # about ~8 minutes on a t2.micro
    make check
    # fails on (maybe the test fails but library is ok?)
    # /bin/ld: cannot find -lstdc++
    # collect2: error: ld returned 1 exit status
  popd
popd
# Install KRB5 statically-linked
curl -OL http://web.mit.edu/kerberos/dist/krb5/1.12/krb5-1.12.3-signed.tar
tar xvf krb5-1.12.3-signed.tar
tar xvf krb5-1.12.3.tar.gz
pushd krb5-1.12.3/src
    e./confgure \
  # I don't think '--prefix' matters, but I'm superstitious
  ./configure \
    --prefix=${BOSH_INSTALL_TARGET} \
    --enable-static \
    --disable-shared
  make
  # Install bind
popd
curl -OL ftp://ftp.isc.org/isc/bind9/9.10.2/bind-9.10.2.tar.gz
tar xvzf bind-9.10.2.tar.gz
pushd bind-9.10.2
  # CFLAGS
  # -static static compilation to avoid deploy-time requirement to install
  #    libraries via yum/apt-get. Need GSSAPI directory for headers
  # -I /usr/include/gssapi to avoid error
  #    configure: error: could not determine proper GSSAPI linkage
  #    /bin/ld: cannot find -lgss
  #    /bin/ld: cannot find -lkrb5
  export CFLAGS='-static -I/usr/include/gssapi/ -L../krb5-1.12.3/src/lib/ -L../krb5-1.12.3/src/lib/gssapi -lgssapi_krb5'
  ./configure \
    --prefix=${BOSH_INSTALL_TARGET} \
    --localstatedir=/var/vcap/sys
  make
  make install
popd
